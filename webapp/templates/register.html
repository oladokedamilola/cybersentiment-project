{% extends "base.html" %}
{% block title %}Register - CyberSentiment{% endblock %}

{% block content %}
<style>
  .form-errors {
    color: #dc3545;
    font-size: 0.9rem;
    font-weight: 500;
    margin-bottom: 1rem;
    padding: 0.75rem 1rem;
    border: 1px solid #f5c2c7;
    background-color: #f8d7da;
    border-radius: 0.5rem;
  }
</style>

<div class="min-vh-100 d-flex align-items-center justify-content-center bg-light m-5">
  <div class="card shadow-lg rounded-4 border-0 w-100" style="max-width: 500px; margin-top: -50px;">
    <div class="card-body p-4">
      <h2 class="h4 fw-bold mb-4 text-center text-primary">Create Your Account</h2>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <form method="POST" novalidate>
        {{ form.hidden_tag() }}

        <!-- Username -->
        <div class="mb-3">
          {{ form.username.label(class="form-label") }}
          {{ form.username(class="form-control", placeholder="Choose a username") }}
          {% if form.username.errors %}
            <div class="invalid-feedback d-block">{{ form.username.errors[0] }}</div>
          {% endif %}
        </div>

        <!-- Email -->
        <div class="mb-3">
          {{ form.email.label(class="form-label") }}
          {{ form.email(class="form-control", placeholder="you@example.com") }}
          {% if form.email.errors %}
            <div class="invalid-feedback d-block">{{ form.email.errors[0] }}</div>
          {% endif %}
        </div>

        <!-- Password -->
        <div class="mb-3">
          {{ form.password.label(class="form-label") }}
          <div class="input-group">
            {{ form.password(class="form-control", id="password") }}
            <button type="button" class="btn btn-outline-secondary toggle-password" data-target="password">
              <i class="bi bi-eye"></i>
            </button>
          </div>
          <div class="form-text text-muted">Must be strong and secure.</div>

          <!-- Password rules -->
          <div id="password-rules-wrapper" class="overflow-hidden" style="max-height: 0; transition: max-height 0.4s ease;">
            <ul class="list-unstyled small mt-2" id="password-rules">
              <li id="rule-length" class="text-danger">❌ At least 8 characters</li>
              <li id="rule-uppercase" class="text-danger">❌ One uppercase letter</li>
              <li id="rule-lowercase" class="text-danger">❌ One lowercase letter</li>
              <li id="rule-number" class="text-danger">❌ One number</li>
              <li id="rule-symbol" class="text-danger">❌ One special character</li>
            </ul>
          </div>

          {% if form.password.errors %}
            <div class="invalid-feedback d-block">{{ form.password.errors[0] }}</div>
          {% endif %}
        </div>

        <!-- Confirm Password -->
        <div class="mb-3">
          {{ form.confirm_password.label(class="form-label") }}
          <div class="input-group">
            {{ form.confirm_password(class="form-control", id="confirm_password") }}
            <button type="button" class="btn btn-outline-secondary toggle-password" data-target="confirm_password">
              <i class="bi bi-eye"></i>
            </button>
          </div>
          {% if form.confirm_password.errors %}
            <div class="invalid-feedback d-block">{{ form.confirm_password.errors[0] }}</div>
          {% endif %}
        </div>

        <!-- Submit -->
        <button type="submit" class="btn btn-primary w-100 py-2 shadow-sm" id="registerBtn" disabled>
          Register
        </button>

      </form>

      <p class="mt-4 text-center text-muted small">
        Already have an account?
        <a href="{{ url_for('auth.login') }}" class="fw-semibold text-decoration-none">Login here</a>
      </p>
    </div>
  </div>
</div>

<!-- Password Toggle Script -->
<script>
  document.querySelectorAll('.toggle-password').forEach(function (button) {
    button.addEventListener('click', function () {
      const targetId = this.getAttribute('data-target');
      const input = document.getElementById(targetId);
      const icon = this.querySelector('i');
      const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
      input.setAttribute('type', type);
      icon.classList.toggle('bi-eye');
      icon.classList.toggle('bi-eye-slash');
    });
  });

  const passwordInput = document.getElementById('password');
  const rulesWrapper = document.getElementById('password-rules-wrapper');
  const registerBtn = document.getElementById('registerBtn');

  const rules = {
    length: document.getElementById('rule-length'),
    uppercase: document.getElementById('rule-uppercase'),
    lowercase: document.getElementById('rule-lowercase'),
    number: document.getElementById('rule-number'),
    symbol: document.getElementById('rule-symbol')
  };

  function validatePasswordRules(value) {
    const validations = {
      length: value.length >= 8,
      uppercase: /[A-Z]/.test(value),
      lowercase: /[a-z]/.test(value),
      number: /[0-9]/.test(value),
      symbol: /[^A-Za-z0-9]/.test(value)
    };

    // Update rule UI
    rules.length.classList.toggle('text-success', validations.length);
    rules.length.classList.toggle('text-danger', !validations.length);
    rules.length.textContent = (validations.length ? '✅' : '❌') + ' At least 8 characters';

    rules.uppercase.classList.toggle('text-success', validations.uppercase);
    rules.uppercase.classList.toggle('text-danger', !validations.uppercase);
    rules.uppercase.textContent = (validations.uppercase ? '✅' : '❌') + ' One uppercase letter';

    rules.lowercase.classList.toggle('text-success', validations.lowercase);
    rules.lowercase.classList.toggle('text-danger', !validations.lowercase);
    rules.lowercase.textContent = (validations.lowercase ? '✅' : '❌') + ' One lowercase letter';

    rules.number.classList.toggle('text-success', validations.number);
    rules.number.classList.toggle('text-danger', !validations.number);
    rules.number.textContent = (validations.number ? '✅' : '❌') + ' One number';

    rules.symbol.classList.toggle('text-success', validations.symbol);
    rules.symbol.classList.toggle('text-danger', !validations.symbol);
    rules.symbol.textContent = (validations.symbol ? '✅' : '❌') + ' One special character';

    // Enable button only if all rules pass
    const allValid = Object.values(validations).every(Boolean);
    registerBtn.disabled = !allValid;
  }

  passwordInput.addEventListener('focus', () => {
    rulesWrapper.style.maxHeight = '500px';
  });

  passwordInput.addEventListener('blur', () => {
    if (passwordInput.value.trim() === '') {
      rulesWrapper.style.maxHeight = '0';
    }
  });

  passwordInput.addEventListener('input', () => {
    validatePasswordRules(passwordInput.value);
  });

  // Initial check (if form re-renders with password filled)
  validatePasswordRules(passwordInput.value);
</script>


<!-- Bootstrap Icons (if not already in base.html) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
{% endblock %}
